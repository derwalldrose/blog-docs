import fs from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'

const __dirname = path.dirname(fileURLToPath(import.meta.url))
const blogDir = path.join(__dirname, '../docs/blog')

const stripQuotes = (value = '') => String(value).trim().replace(/^['"]|['"]$/g, '')

// 读取所有博客文章
const posts = []
const files = fs.readdirSync(blogDir)

files.forEach((file) => {
  if (file.endsWith('.md') && file !== 'index.md' && !file.includes('blog.data')) {
    const filePath = path.join(blogDir, file)
    const content = fs.readFileSync(filePath, 'utf-8')

    // 提取 frontmatter（简单解析：key: value）
    const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/)
    const frontmatter = {}

    if (frontmatterMatch) {
      const lines = frontmatterMatch[1].split('\n')
      lines.forEach((line) => {
        const [key, ...valueParts] = line.split(':')
        if (key && valueParts.length) {
          frontmatter[key.trim()] = valueParts.join(':').trim()
        }
      })
    }

    // 提取标题
    const titleMatch = content.match(/^#\s+(.+)$/m)
    const title = stripQuotes(frontmatter.title || titleMatch?.[1] || file.replace('.md', ''))

    // 提取描述
    const description = stripQuotes(frontmatter.description || '')

    // 提取日期（兼容 date / pubDate）
    const date = stripQuotes(frontmatter.date || frontmatter.pubDate || '')

    posts.push({
      title,
      description,
      date,
      url: `/blog/${file.replace('.md', '')}`
    })
  }
})

// 按日期排序（日期无效则排在后面）
posts.sort((a, b) => {
  const tb = Number.isNaN(Date.parse(b.date)) ? 0 : Date.parse(b.date)
  const ta = Number.isNaN(Date.parse(a.date)) ? 0 : Date.parse(a.date)
  return tb - ta
})

// 生成 JSON 文件
fs.writeFileSync(
  path.join(__dirname, '../docs/blog/blog.data.json'),
  JSON.stringify({ data: posts }, null, 2) + '\n'
)

// 同步生成 TS 文件，避免 blog.data.ts 被清空导致页面/组件拿不到数据
const tsContent = `// THIS FILE IS AUTO-GENERATED by scripts/generate-blog-data.js\n// DO NOT EDIT MANUALLY.\n\nexport interface BlogPost {\n  title: string\n  description: string\n  date: string\n  url: string\n}\n\nexport const data: BlogPost[] = ${JSON.stringify(posts, null, 2)}\n\nexport default { data }\n`

fs.writeFileSync(path.join(__dirname, '../docs/blog/blog.data.ts'), tsContent)

console.log(`Generated blog data for ${posts.length} posts`)
